{
  "name": "Data Analyzer - Execute Plan",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "execute-plan",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        1552,
        192
      ],
      "id": "676d99ee-16a2-4fdc-aab2-c4796ef1bd1f",
      "name": "Webhook",
      "webhookId": "ep-webhook-id-001"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body;\nlet plan;\ntry {\n  plan = typeof body.plan === 'string' ? JSON.parse(body.plan) : body.plan;\n} catch (e) {\n  throw new Error('Invalid plan JSON: ' + e.message);\n}\n\nconst report_id = 'rpt_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);\n\nconst items = plan.steps.map(step => ({\n  json: {\n    report_id,\n    plan_id: plan.plan_id || '',\n    email: body.email,\n    model: body.model || 'moonshotai/kimi-k2.5',\n    total_steps: plan.total_steps || plan.steps.length,\n    templateId: body.templateId || '',\n    step: step\n  }\n}));\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1760,
        192
      ],
      "id": "89e83eef-9b80-44f1-9f5e-d353777d321a",
      "name": "Parse Plan & Generate Report ID"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ report_id: $input.first().json.report_id, total_steps: $input.first().json.total_steps, status: 'started' }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1984,
        -32
      ],
      "id": "a2575a00-e2a7-4304-bb2a-2242e9241181",
      "name": "Respond Immediately"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1984,
        192
      ],
      "id": "88170b37-82c1-46e8-92e6-ecfdb3db57a8",
      "name": "Loop Over Steps"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO n8n_data.report_step_results (report_id, plan_id, step_number, purpose, dataset_id, step_result, status) VALUES ('{{ $json.report_id }}', '{{ $json.plan_id }}', {{ $json.step.step_number }}, '{{ $json.step.purpose.replace(/'/g, \"''\") }}', '{{ $json.step.dataset_id }}', '', 'started')",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2208,
        192
      ],
      "id": "2e8f01bd-c60c-4a4f-b4d1-0d57b8369fa2",
      "name": "Mark Step Started",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT column_mapping FROM n8n_data.dataset_record_manager WHERE dataset_id = '{{ $('Loop Over Steps').item.json.step.dataset_id }}' LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2432,
        192
      ],
      "id": "fetch-col-map-001",
      "name": "Fetch Column Mapping",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const datasetId = $('Loop Over Steps').item.json.step.dataset_id;\n\n// Aggregate steps have no real dataset - skip view creation\nif (!datasetId || datasetId === 'aggregation_step') {\n  return [{ json: { view_sql: null } }];\n}\n\n// Parse column_mapping from Fetch Column Mapping output\nlet mapping = {};\ntry {\n  const raw = $input.first().json.column_mapping;\n  mapping = typeof raw === 'string' ? JSON.parse(raw) : (raw || {});\n} catch(e) {\n  // Fall back to no aliases - view will still filter by dataset_id\n}\n\n// Build SELECT aliases: string1 AS \"Original Name\", ...\nconst aliases = Object.entries(mapping)\n  .map(([origName, genericCol]) => `${genericCol} AS \"${origName.replace(/\"/g, '\"\"')}\"`)\n  .join(',\\n  ');\n\nconst selectClause = aliases.length > 0 ? aliases : '*';\nconst safeDatasetId = datasetId.replace(/'/g, \"''\");\n\nconst viewSql = `CREATE OR REPLACE VIEW n8n_data.v_step_current AS\\nSELECT ${selectClause}\\nFROM n8n_data.universal_datatable\\nWHERE dataset_id = '${safeDatasetId}'`;\n\nreturn [{ json: { view_sql: viewSql } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2656,
        192
      ],
      "id": "build-step-view-001",
      "name": "Build Step View SQL"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.view_sql || 'SELECT 1' }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2880,
        192
      ],
      "id": "create-step-view-001",
      "name": "Create Step View",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Execute the following step of a report plan.\n\nREPORT ID: {{ $('Parse Plan & Generate Report ID').item.json.report_id }}\nSTEP NUMBER: {{ $('Parse Plan & Generate Report ID').item.json.step.step_number }} of {{ $('Parse Plan & Generate Report ID').item.json.total_steps }}\nPURPOSE: {{ $('Loop Over Steps').item.json.step.purpose }}\nDATASET ID: {{ $('Loop Over Steps').item.json.step.dataset_id }}\n\nQUERY STRATEGY:\n- Filters: {{ JSON.stringify($('Loop Over Steps').item.json.step.query_strategy.filters) }}\n- Columns needed: {{ $('Loop Over Steps').item.json.step.query_strategy.columns.join(', ') }}\n- Logic: {{ $('Loop Over Steps').item.json.step.query_strategy.logic }}\n- Join on: {{ $('Loop Over Steps').item.json.step.query_strategy.join_on }}\n\nDEPENDENCIES (previous step numbers whose results you may reference): {{ $('Loop Over Steps').item.json.step.dependencies.join(', ') || 'None' }}\nEXPECTED OUTPUT: {{ $('Loop Over Steps').item.json.step.expected_output.join(', ') }}\n\nInstructions:\n1. For 'query' steps: query n8n_data.v_step_current directly using original column names. The view is already filtered to this step's dataset - no column mapping lookup needed.\n2. Build and execute SQL queries using the Query Dataset tool. Always wrap column names in double quotes.\n3. Apply the filters, select the columns, and apply the logic described above.\n4. If this step has dependencies, use the Read Previous Step Results tool to retrieve earlier step results for context.\n5. Analyze the data and return a clear, structured result for this step.",
        "options": {
          "systemMessage": "You are an expert data analyst executing one step of a multi-step report plan.\n\nIMPORTANT:\n- A view n8n_data.v_step_current has been pre-created containing only this step's dataset, with original column names already applied. Query it directly - no column mapping lookup needed, no dataset_id filter needed.\n- Always wrap column names in double quotes (e.g., \"Revenue\", \"Customer Name\") and string values in single quotes.\n- For aggregate steps (dataset_id = 'aggregation_step'), do NOT query v_step_current. Instead, use the Read Previous Step Results tool to get data from dependent steps and perform calculations.\n- Use the Calculator tool for arithmetic.\n- Return a structured analysis with data tables, calculations, and findings.\n- Be concise but thorough.",
          "maxIterations": 30
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        3104,
        192
      ],
      "id": "3ddadf76-2ac5-4252-b283-b849f957f33a",
      "name": "Step AI Agent",
      "alwaysOutputData": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "model": "={{ $('Webhook').item.json.body.model || 'moonshotai/kimi-k2.5' }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2976,
        416
      ],
      "id": "73ff5f68-c4c1-44e2-9836-1ddd8a98d46a",
      "name": "Step LLM",
      "credentials": {
        "openRouterApi": {
          "id": "SScyp7rqdYRmN9lx",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Read results from previously completed steps of this report. Use this when the current step has dependencies on earlier steps.",
        "operation": "executeQuery",
        "query": "=SELECT step_number, purpose, step_result FROM n8n_data.report_step_results WHERE report_id = '{{ $('Parse Plan & Generate Report ID').item.json.report_id }}' {{ $fromAI(\"step_filter\", \"Optional: AND step_number = N to get a specific step, or empty for all steps\") }} ORDER BY step_number",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3296,
        416
      ],
      "id": "9b525bb8-7ce9-4025-81d6-9262eca4970b",
      "name": "Read Previous Step Results",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE n8n_data.report_step_results SET step_result = '{{ $json.output ? $json.output.replace(/'/g, \"''\") : \"No output generated by AI\" }}', status = '{{ ($json.output && $json.output.trim()) ? \"completed\" : \"error\" }}' WHERE report_id = '{{ $('Loop Over Steps').first().json.report_id }}' AND step_number = {{ $('Loop Over Steps').first().json.step.step_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2848,
        160
      ],
      "id": "a691ce60-fbd8-4251-a10c-598dc82d62cd",
      "name": "Save Step Result",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT step_number, purpose, dataset_id, step_result FROM n8n_data.report_step_results WHERE report_id = '{{ $('Parse Plan & Generate Report ID').first().json.report_id }}' AND step_number > 0 ORDER BY step_number",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2688,
        -32
      ],
      "id": "98ba5304-d191-4334-8aeb-dd24e856e2ba",
      "name": "Load All Step Results",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const steps = $input.all().map(item => item.json);\nconst src = $('Parse Plan & Generate Report ID').first().json;\n\nlet stepsText = '';\nfor (const s of steps) {\n  stepsText += `\\n=== STEP ${s.step_number}: ${s.purpose} ===\\nDataset: ${s.dataset_id}\\n\\n${s.step_result}\\n\\n`;\n}\n\nreturn [{\n  json: {\n    report_id: src.report_id,\n    plan_id: src.plan_id,\n    email: src.email,\n    model: src.model,\n    templateId: src.templateId || '',\n    all_step_results: stepsText,\n    step_count: steps.length\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2896,
        -32
      ],
      "id": "5b5d4917-484f-4494-8f70-b2f6735dde92",
      "name": "Combine Step Results"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE n8n_data.report_step_results SET step_result = '{{ ($json.error ? (typeof $json.error === \"object\" ? JSON.stringify($json.error) : String($json.error)) : \"Step failed\").replace(/'/g, \"''\") }}', status = 'error' WHERE report_id = '{{ $('Loop Over Steps').item.json.report_id }}' AND step_number = {{ $('Loop Over Steps').item.json.step.step_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4352,
        816
      ],
      "id": "1f4db4d8-e647-4701-b6a1-1acca21685f3",
      "name": "Save Step Error",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        3136,
        416
      ],
      "id": "02e46373-e208-413b-945b-873d145f8db3",
      "name": "Calculator"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Look up dataset metadata including column_mapping and dataset_summary. Query the n8n_data.dataset_record_manager table.",
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "n8n_data",
          "mode": "list",
          "cachedResultName": "n8n_data"
        },
        "table": {
          "__rl": true,
          "value": "dataset_record_manager",
          "mode": "list",
          "cachedResultName": "dataset_record_manager"
        },
        "where": {
          "values": [
            {
              "column": "dataset_id",
              "value": "={{ $fromAI(\"dataset_id\", \"The dataset_id to query\") }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2640,
        432
      ],
      "id": "420e641e-c8f8-464b-975e-cd5d35370f5f",
      "name": "Dataset Information",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query data rows for the current step. Use SQL to query n8n_data.v_step_current - it is already filtered to this step's dataset and uses original column names (not generic names like string1). Always wrap column names in double quotes. Do NOT add a WHERE dataset_id clause.",
        "operation": "executeQuery",
        "query": "{{ $fromAI('sql_query') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2800,
        432
      ],
      "id": "7530f76b-367e-42a7-a7ee-2904f7c59c09",
      "name": "Query Dataset",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO n8n_data.report_step_results (report_id, plan_id, step_number, purpose, dataset_id, step_result, status) VALUES ('{{ $('Combine Step Results').first().json.report_id }}', '', 0, 'Final Consolidated Report', '', '{{ $json.output ? (typeof $json.output === \"object\" ? ($json.output.content || JSON.stringify($json.output)) : String($json.output)).replace(/\\n/g, '').replace(/'/g, \"''\") : \"No report\" }}', 'final_report')",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4224,
        -256
      ],
      "id": "a370bb4f-42c3-4343-92c9-c7a2177146e5",
      "name": "Save Final Report",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO n8n_data.report_step_results (report_id, plan_id, step_number, purpose, dataset_id, step_result, status) VALUES ('{{ $('Combine Step Results').first().json.report_id }}', '', 0, 'Formatter Error', '', '{{ $json.error ? (typeof $json.error === \"object\" ? JSON.stringify($json.error) : String($json.error)).replace(/'/g, \"''\") : \"Formatter failed\" }}', 'error')",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4208,
        384
      ],
      "id": "735af971-9782-4fb3-bc74-1aa98db8677e",
      "name": "Save Formatter Error",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": "openai/gpt-oss-120b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3568,
        -16
      ],
      "id": "cd964b5e-e443-4356-9a1a-93eabfe6fc86",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "SScyp7rqdYRmN9lx",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"subject\": \"Technical Analysis\",\n  \"content\": \"Multiple short positions were initiated based on technical patterns indicating overextended moves and impending pullbacks.\"\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        3808,
        64
      ],
      "id": "162e8800-6c61-4496-8d11-17bdce7891da",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": "openai/gpt-oss-120b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3808,
        240
      ],
      "id": "0425816b-b48f-4341-b9d2-3edafdbcfdd4",
      "name": "OpenRouter Chat Model4",
      "credentials": {
        "openRouterApi": {
          "id": "SScyp7rqdYRmN9lx",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Uses template_id to query and fetch report template HTML",
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "n8n_data",
          "mode": "list",
          "cachedResultName": "n8n_data"
        },
        "table": {
          "__rl": true,
          "value": "data-analyzer-report-templates",
          "mode": "list",
          "cachedResultName": "data-analyzer-report-templates"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "template_id",
              "value": "={{ $('Webhook').first().json.body.templateId }}"
            }
          ]
        },
        "options": {
          "outputColumns": [
            "html"
          ]
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3632,
        192
      ],
      "id": "61ea19e7-f152-40f6-8efd-158a760c8773",
      "name": "Report Template",
      "credentials": {
        "postgres": {
          "id": "5JhwTls4nSPISJqU",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Consolidate the following {{ $json.step_count }} step results into a single coherent, professional report and format it as styled HTML.\n\nREPORT ID: {{ $json.report_id }}\nPLAN ID: {{ $json.plan_id }}\n\nSTEP RESULTS:\n{{ $json.all_step_results }}",
        "options": {
          "systemMessage": "=Role: You are an expert report writer and HTML formatter.\n\nYour job has TWO parts:\n\nPART 1 - CONSOLIDATE: Take the individual analysis step results and consolidate them into a single, professional, well-structured report with:\n- Executive Summary - Key findings and highlights\n- Detailed Analysis - One section per step, incorporating the data and findings\n- Cross-step Insights - Connections and patterns across different analysis steps\n- Conclusions & Recommendations\nUse clear headings, bullet points, data tables where appropriate, and professional language. Present numbers with appropriate formatting. If any step had errors or missing data, note it but don't let it derail the overall report.\n\nPART 2 - FORMAT AS HTML: Query the 'Report Template' tool using template_Id: {{ $json.templateId }} to fetch reference HTML code.\nIf a reference HTML template is fetched, use its CSS and structure as the master template and map the consolidated report data into it. Prioritize the template's styles (colors, fonts, borders) above all else.\nIf no reference HTML is fetched, format the report as clean, professional HTML with inline styles.\n\nMake sure to eliminate any unnecessary tags or symbols that will get in the way of clean report such as \" \\n\"\n\nIMPORTANT: DO NOT OUTPUT THE PLAN, COMMENT OR EXPLANATION OF THE ACTION. JUST OUTPUT HTML."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        3664,
        -240
      ],
      "id": "e84fd5fa-bc84-4d16-aa67-ce6962a2d3d4",
      "name": "Formatter",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Get the HTML content from the previous node\nconst item = $input.first().json;\nlet html = item.output || \"\";\n\nif (typeof html !== 'string') {\n  // If the output is an object (e.g., from the Structured Output Parser), \n  // try to extract the content/html field\n  html = html.content || html.html || JSON.stringify(html);\n}\n\n/**\n * CLEANUP LOGIC\n */\n\n// 1. Remove Newlines and Carriage Returns\nhtml = html.replace(/[\\n\\r]/g, '');\n\n// 2. Remove tabs and sequences of multiple spaces\nhtml = html.replace(/\\t/g, '');\nhtml = html.replace(/\\s{2,}/g, ' ');\n\n// 3. Remove \"meaningless\" or empty common tags (e.g., <span></span> or <p></p>)\n// This regex looks for tags that contain only whitespace or nothing at all\nhtml = html.replace(/<(span|p|div|section)>\\s*<\\/\\1>/gi, '');\n\n// 4. Clean up common AI residuals like markdown code blocks if they were accidentally included\nhtml = html.replace(/^```html|```$/g, '');\n\n// 5. Trim leading/trailing whitespace\nhtml = html.trim();\n\nreturn {\n  json: {\n    ...item,\n    cleaned_html: html\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4016,
        -256
      ],
      "id": "ef92227d-c037-4f84-b15c-8d56da6abd64",
      "name": "Clean Up"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Plan & Generate Report ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Plan & Generate Report ID": {
      "main": [
        [
          {
            "node": "Respond Immediately",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Steps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Steps": {
      "main": [
        [
          {
            "node": "Load All Step Results",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark Step Started",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Step Started": {
      "main": [
        [
          {
            "node": "Fetch Column Mapping",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Column Mapping": {
      "main": [
        [
          {
            "node": "Build Step View SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Step View SQL": {
      "main": [
        [
          {
            "node": "Create Step View",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Step View": {
      "main": [
        [
          {
            "node": "Step AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step AI Agent": {
      "main": [
        [
          {
            "node": "Save Step Result",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Step Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Step Result": {
      "main": [
        [
          {
            "node": "Loop Over Steps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load All Step Results": {
      "main": [
        [
          {
            "node": "Combine Step Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Step Results": {
      "main": [
        [
          {
            "node": "Formatter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step LLM": {
      "ai_languageModel": [
        [
          {
            "node": "Step AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Read Previous Step Results": {
      "ai_tool": [
        [
          {
            "node": "Step AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Save Step Error": {
      "main": [
        [
          {
            "node": "Loop Over Steps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Step AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Query Dataset": {
      "ai_tool": [
        [
          {
            "node": "Step AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Formatter",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Report Template": {
      "ai_tool": [
        [
          {
            "node": "Formatter",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Formatter": {
      "main": [
        [
          {
            "node": "Clean Up",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Formatter Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean Up": {
      "main": [
        [
          {
            "node": "Save Final Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "26b58291-db1c-4e7c-86ac-afbdf91b959c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "558d88703fb65b2d0e44613bc35916258b0f0bf983c5d4730c00c424b77ca36a"
  },
  "id": "taHjSlURcGuHr_vMzffkE",
  "tags": []
}
