{"name":"Data Analyzer - Upload Dataset API","nodes":[{"parameters":{"httpMethod":"POST","path":"upload-dataset","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1008,208],"id":"webhook-upload","name":"Webhook","webhookId":"upload-dataset-webhook"},{"parameters":{"jsCode":"var webhookData = $input.first().json.body;\nvar base64Data = webhookData.csvData;\nif (!base64Data) {\n  throw new Error(\"No csvData found in request\");\n}\n\nvar datasetName = webhookData.datasetName || \"Unnamed Dataset\";\nvar description = webhookData.description || \"\";\nvar email = webhookData.email || \"\";\n\nvar csvText = Buffer.from(base64Data, \"base64\").toString(\"utf-8\");\n\n// Strip BOM if present\nif (csvText.charCodeAt(0) === 0xFEFF) {\n  csvText = csvText.slice(1);\n}\n\n// --- MULTILINE-AWARE CSV PARSER ---\nfunction parseCSV(text) {\n  const rows = [];\n  let row = [];\n  let cell = '';\n  let inQuotes = false;\n\n  for (let i = 0; i < text.length; i++) {\n    const char = text[i];\n    const next = text[i + 1];\n\n    if (char === '\"') {\n      if (inQuotes && next === '\"') {\n        cell += '\"';\n        i++;\n      } else {\n        inQuotes = !inQuotes;\n      }\n    } else if (char === ',' && !inQuotes) {\n      row.push(cell.trim());\n      cell = '';\n    } else if (!inQuotes && (char === '\\n' || char === '\\r')) {\n      if (char === '\\r' && next === '\\n') i++;\n      row.push(cell.trim());\n      if (row.some(v => v !== '')) {\n        rows.push(row);\n      }\n      row = [];\n      cell = '';\n    } else {\n      cell += char;\n    }\n  }\n\n  // Flush final row\n  if (cell || row.length) {\n    row.push(cell.trim());\n    if (row.some(v => v !== '')) {\n      rows.push(row);\n    }\n  }\n\n  return rows;\n}\n// ----------------------------------\n\nvar allRows = parseCSV(csvText);\n\nif (allRows.length < 2) {\n  throw new Error(\"CSV must have header and data rows\");\n}\n\nvar headers = allRows[0];\nvar rows = [];\n\nfor (var i = 1; i < allRows.length; i++) {\n  var values = allRows[i];\n  var row = {};\n  for (var j = 0; j < headers.length; j++) {\n    row[headers[j]] = values[j] !== undefined ? values[j] : \"\";\n  }\n  rows.push({ json: row });\n}\n\nif (rows.length === 0) {\n  throw new Error(\"No data rows found\");\n}\n\n$execution.customData.set(\"datasetName\", datasetName);\n$execution.customData.set(\"description\", description);\n$execution.customData.set(\"email\", email);\n\nreturn rows;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-800,208],"id":"parse-csv","name":"Parse CSV"},{"parameters":{"jsCode":"var items = $input.all();\nif (items.length === 0) return { error: \"No data received.\" };\n\nvar datasetName = $execution.customData.get(\"datasetName\") || \"Test\";\nvar datasetDesc = $execution.customData.get(\"description\") || \"\";\nvar email = $execution.customData.get(\"email\") || \"\";\n\nfunction detectType(val) {\n  if (val === null || val === undefined || String(val).trim() === \"\") return \"null\";\n  var str = String(val).trim();\n\n  // 1. Enhanced Date Detection (Strict ISO, US Slanted, and Dash formats)\n  var strictDate = /^\\d{4}-\\d{2}-\\d{2}$|^\\d{1,2}[\\/-]\\d{1,2}[\\/-]\\d{2,4}$/;\n  // Also check if it's a valid date object string (like \"2023-10-27T10:00:00Z\")\n  if (strictDate.test(str) || !isNaN(Date.parse(str)) && isNaN(str)) {\n    return \"date\";\n  }\n\n  // 2. Boolean Detection\n  if (str.toLowerCase() === \"true\" || str.toLowerCase() === \"false\") return \"bool\";\n\n  // 3. Numeric Detection (Cleaned of currency/commas)\n  var cleanNum = str.replace(/[$,]/g, \"\");\n  if (cleanNum !== \"\" && !isNaN(cleanNum)) {\n    if (str.indexOf(\".\") !== -1 || Math.abs(parseFloat(cleanNum)) > 999999) {\n      return \"real\";\n    }\n    return \"int\";\n  }\n\n  return \"string\";\n}\n\nfunction getWinnerType(current, next) {\n  if (!current || current === \"null\") return next;\n  if (next === \"null\") return current;\n  \n  // Hierarchy: String kills everything. \n  // Dates should stay Dates unless mixed with text.\n  if (current === \"string\" || next === \"string\") return \"string\";\n  \n  // If we have mixed Date and Numbers, we usually default to String\n  if ((current === \"date\" && next !== \"date\") || (next === \"date\" && current !== \"date\")) {\n    return \"string\";\n  }\n\n  if (current === \"real\" || next === \"real\") return \"real\";\n  if (current === \"int\" && next === \"int\") return \"int\";\n  \n  return current;\n}\n\nvar columnTypes = {};\nitems.forEach(function(item) {\n  var entries = Object.entries(item.json);\n  for (var i = 0; i < entries.length; i++) {\n    var key = entries[i][0];\n    var value = entries[i][1];\n    var type = detectType(value);\n    columnTypes[key] = getWinnerType(columnTypes[key], type);\n  }\n});\n\nvar counters = { string: 1, real: 1, int: 1, date: 1, bool: 1 };\nvar mapping = {};\nvar dictionary = {};\n// Trim and deduplicate headers (trim before sort to group identical trimmed names)\nvar headers = [...new Set(Object.keys(columnTypes).map(k => k.trim()))].sort();\n// Rebuild columnTypes with trimmed keys\nvar trimmedColumnTypes = {};\nObject.keys(columnTypes).forEach(k => {\n  var tk = k.trim();\n  trimmedColumnTypes[tk] = getWinnerType(trimmedColumnTypes[tk], columnTypes[k]);\n});\ncolumnTypes = trimmedColumnTypes;\n\nfor (var i = 0; i < headers.length; i++) {\n  var header = headers[i].trim();\n  var type = columnTypes[header];\n  if (type === \"null\") type = \"string\";\n\n  // This creates column names like date1, date2, etc.\n  var dbColumn = type + counters[type];\n  mapping[header] = dbColumn;\n  dictionary[dbColumn] = { \n    original_name: header, \n    data_type: type \n  };\n  counters[type]++;\n}\n\nreturn {\n  dataset_name: datasetName.replace(/'/g, \"''\"),\n  dataset_summary: datasetDesc.replace(/'/g, \"''\"),\n  owner_email: email,\n  column_mapping: mapping,\n  column_dictionary: dictionary,\n  total_row_count: items.length\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-608,208],"id":"mapping-logic","name":"Mapping Logic"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-summary","leftValue":"={{ $json.dataset_summary }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-400,208],"id":"if-summary","name":"If Summary Empty"},{"parameters":{"jsCode":"var items = $(\"Parse CSV\").all();\nif (items.length === 0) return [];\n\nvar shuffled = items.slice();\nfor (var i = shuffled.length - 1; i > 0; i--) {\n  var j = Math.floor(Math.random() * (i + 1));\n  var temp = shuffled[i];\n  shuffled[i] = shuffled[j];\n  shuffled[j] = temp;\n}\n\nreturn shuffled.slice(0, 100);"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-208,112],"id":"sample-data","name":"Sample Data"},{"parameters":{"promptType":"define","text":"=Analyze the following dataset as a single block to build a SQL Search Index:\n{{ JSON.stringify($input.all().map(i => i.json)) }}","needsFallback":true,"options":{"systemMessage":"ROLE You are a Senior Database Engineer and Metadata Architect. Your task is to analyze a 100-row data block and identify Filtering Columns - those that contain categories, types, or groupings suitable for SQL WHERE clauses.\n\nYOUR TASK\n\n1. Categorical Discovery: Scan the data for columns with a limited set of recurring values (Low Cardinality). These are your primary filtering targets.\n\n2. Mapping Intent: For each identified column, define what business question it answers.\n\n3. Exact Value Extraction: Extract the exact unique values found in the sample to ensure 100% match accuracy in SQL queries.\n\n4. Ignore Noise: Do not analyze unique identifiers (Names, IDs), numerical metrics (Amounts), or Date/Time stamps. \n\nOUTPUT FORMAT: Provide a structured entry for every identified Filtering Column.\n\n[Exact Column Header]\nBusiness Logic: [e.g., Defines the stage of the transaction]\nSQL Filter Values: [Value A], [Value B], [Value C]\nQuery Instruction: [e.g., Use this column when the user asks for Current Status or Progress]\nSyntax Note: [e.g., Contains curly apostrophe or Case-sensitive]\n\nSTRICT RULES:\n- No Explanation: Start the output immediately with the first column.\n- Categorical Only: Only include columns that act as groups or types.\n- Direct Output: This text will be saved directly to a database record.\n- Exclude Totals: Include in the summary a statement to prevent double counting. Something like \"When summing up, exclude rows that have Total in the label to avoid double counting.\"  ","maxIterations":25,"returnIntermediateSteps":false}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[0,112],"id":"ai-agent","name":"AI Agent","executeOnce":true},{"parameters":{"model":"x-ai/grok-4.1-fast","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-16,352],"id":"openrouter-model","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"SScyp7rqdYRmN9lx","name":"OpenRouter account"}}},{"parameters":{"jsCode":"var rawText = $json.output || \"\";\nvar sanitizedText = rawText.replace(/```[a-z]*\\n?/g, \"\").replace(/```/g, \"\").trim();\nvar sections = sanitizedText.split(/(?=\\[[^\\]]+\\])/g);\n\nvar mdRows = [];\nsections.forEach(function(section) {\n  if (!section.trim()) return;\n  var lines = section.trim().split(/\\r?\\n/);\n  var header = lines.shift().replace(/[\\[\\]]/g, \"\").trim();\n  var sectionMd = \"### \" + header + \"\\n\";\n  \n  for (var i = 0; i < lines.length; i++) {\n    var line = lines[i];\n    if (line.indexOf(\":\") !== -1) {\n      var parts = line.split(\":\");\n      var key = parts[0].trim();\n      var value = parts.slice(1).join(\":\").trim().replace(/'/g, \"''\");\n      sectionMd += \"* **\" + key + \":** \" + value + \"\\n\";\n    } else if (line.trim()) {\n      var extra = line.trim().replace(/'/g, \"''\");\n      sectionMd += \"* _\" + extra + \"_\\n\";\n    }\n  }\n  mdRows.push(sectionMd);\n});\n\nreturn { cleaned_summary: mdRows.join(\"\\n\") };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[336,-112],"id":"clean-summary","name":"Clean Summary"},{"parameters":{"assignments":{"assignments":[{"id":"a1","name":"dataset_name","value":"={{ $(\"Mapping Logic\").first().json.dataset_name }}","type":"string"},{"id":"a2","name":"dataset_summary","value":"={{ $json.cleaned_summary }}","type":"string"},{"id":"a6","name":"owner_email","value":"={{ $(\"Mapping Logic\").first().json.owner_email }}","type":"string"},{"id":"a3","name":"column_mapping","value":"={{ $(\"Mapping Logic\").first().json.column_mapping }}","type":"object"},{"id":"a4","name":"column_dictionary","value":"={{ $(\"Mapping Logic\").first().json.column_dictionary }}","type":"object"},{"id":"a5","name":"total_row_count","value":"={{ $(\"Mapping Logic\").first().json.total_row_count }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[352,112],"id":"set-with-summary","name":"Set With AI Summary"},{"parameters":{"assignments":{"assignments":[{"id":"b1","name":"dataset_name","value":"={{ $(\"Mapping Logic\").first().json.dataset_name }}","type":"string"},{"id":"b2","name":"dataset_summary","value":"={{ $(\"Mapping Logic\").first().json.dataset_summary }}","type":"string"},{"id":"b6","name":"owner_email","value":"={{ $(\"Mapping Logic\").first().json.owner_email }}","type":"string"},{"id":"b3","name":"column_mapping","value":"={{ $(\"Mapping Logic\").first().json.column_mapping }}","type":"object"},{"id":"b4","name":"column_dictionary","value":"={{ $(\"Mapping Logic\").item.json.column_dictionary }}","type":"object"},{"id":"b5","name":"total_row_count","value":"={{ $(\"Mapping Logic\").first().json.total_row_count }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-208,304],"id":"set-no-summary","name":"Set Without AI"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[672,-160],"id":"merge-paths","name":"Merge"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO n8n_data.dataset_record_manager (\n    dataset_name, \n    dataset_summary, \n    row_count, \n    column_mapping, \n    column_dictionary, \n    owner_email,\n    dataset_desc\n) VALUES (\n    '{{ $json.dataset_name.replace(/'/g, \"''\") }}', \n    '{{ $json.dataset_summary.replace(/'/g, \"''\") }}', \n    {{ $json.total_row_count }}, \n    '{{ JSON.stringify($(\"Mapping Logic\").first().json.column_mapping).replace(/'/g, \"''\") }}'::jsonb, \n    '{{ JSON.stringify($(\"Mapping Logic\").first().json.column_dictionary).replace(/'/g, \"''\") }}'::jsonb, \n    '{{ $json.owner_email.replace(/'/g, \"''\") }}',\n'{{ \n$('Webhook').first().json.body.dataset_desc.replace(/'/g, \"''\") }}'\n) \nRETURNING dataset_id;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[800,208],"id":"insert-record","name":"Insert Record Manager","credentials":{"postgres":{"id":"5JhwTls4nSPISJqU","name":"Postgres account"}}},{"parameters":{"jsCode":"// 1. Get mapping and ID\nconst mappingNode = $(\"Mapping Logic\").first();\nconst managerNode = $(\"Insert Record Manager\").first();\n\nif (!mappingNode || !managerNode) {\n    throw new Error(\"Missing input from Mapping Logic or Insert Record Manager\");\n}\n\nconst mapping = mappingNode.json.column_mapping;\nconst datasetId = managerNode.json.dataset_id;\n\n// --- FIX IS HERE: Reference \"Parse CSV\" directly to get the data rows ---\nconst allRows = $(\"Parse CSV\").all(); \n\nconst results = [];\nconst batchSize = 100; // Smaller batches are safer for large SQL strings\nconst mapEntries = Object.entries(mapping);\nconst dbColumnNames = mapEntries.map(entry => entry[1]);\n\nfunction isDateColumn(colName) {\n    const lower = colName.toLowerCase();\n    return lower.includes(\"date\") || lower.includes(\"_at\") || lower.includes(\"time\");\n}\n\nfunction standardizeDate(val) {\n    const d = new Date(val);\n    return isNaN(d.getTime()) ? null : d.toISOString().split(\"T\")[0];\n}\n\nfunction prepareValue(val, targetColumn) {\n    if (val === null || val === undefined || String(val).trim() === \"\") return \"NULL\";\n    \n    let stringVal = String(val).trim();\n    const colLower = targetColumn.toLowerCase();\n    \n    // Numeric handling (strip currency symbols and commas)\n    if (colLower.startsWith(\"int\") || colLower.startsWith(\"real\") || colLower.startsWith(\"numeric\")) {\n        const cleanNum = stringVal.replace(/[,\\s$]/g, \"\");\n        if (cleanNum === \"\" || isNaN(cleanNum)) return \"NULL\";\n        return cleanNum;\n    }\n    \n    // Date handling\n    if (isDateColumn(targetColumn)) {\n        if (/^\\d+$/.test(stringVal) && parseInt(stringVal) > 9999) return \"NULL\";\n        const correctedDate = standardizeDate(stringVal);\n        return correctedDate ? `'${correctedDate}'` : \"NULL\";\n    }\n    \n    // String handling: Escape single quotes AND dollar signs\n    const escaped = stringVal\n        .replace(/'/g, \"''\")\n        .replace(/\\$/g, \"$$$$\"); \n        \n    return `'${escaped}'`;\n}\n\nconst columns = ['\"dataset_id\"', '\"row_index\"'].concat(dbColumnNames.map(c => `\"${c}\"`));\n\nfor (let i = 0; i < allRows.length; i += batchSize) {\n    const chunk = allRows.slice(i, i + batchSize);\n    const valuesList = chunk.map((item, idx) => {\n        const row = item.json;\n        // Ensure datasetId is wrapped in single quotes as it is a UUID/String\n        const rowValues = [`'${datasetId}'`, i + idx + 1]; \n        \n        mapEntries.forEach(entry => {\n            rowValues.push(prepareValue(row[entry[0]], entry[1]));\n        });\n        return `(${rowValues.join(\",\")})`;\n    });\n\n    results.push({ \n        json: { \n            sql: `INSERT INTO n8n_data.universal_datatable (${columns.join(\",\")}) VALUES ${valuesList.join(\",\")};` \n        } \n    });\n}\n\nreturn results;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1008,208],"id":"data-transformer","name":"Data Transformer"},{"parameters":{"operation":"executeQuery","query":"{{ $json.sql }}","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1200,208],"id":"insert-data","name":"Insert Data","credentials":{"postgres":{"id":"5JhwTls4nSPISJqU","name":"Postgres account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { status: \"ok\", datasetId: $(\"Insert Record Manager\").first().json.dataset_id, rowsInserted: $(\"Mapping Logic\").first().json.total_row_count, datasetName:$(\"Mapping Logic\").first().json.dataset_name } }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1408,208],"id":"respond","name":"Respond to Webhook"},{"parameters":{"model":"deepseek/deepseek-v3.2","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[112,352],"id":"3d2b086f-b066-4479-a1df-96ad4553c7de","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"SScyp7rqdYRmN9lx","name":"OpenRouter account"}}},{"parameters":{"operation":"executeQuery","query":"=CREATE OR REPLACE VIEW n8n_data.v_ds_{{ $('Insert Record Manager').first().json.dataset_id.replace(/-/g, '_') }} AS\nSELECT\n    {{\n      Object.entries($('Mapping Logic').first().json.column_mapping)\n      .map(([name, col]) => {\n        const safeName = (name && name.trim() !== \"\") ? name.trim() : `unnamed_${col}`;\n        return `${col} AS \"${safeName}\"`;\n      })\n      .join(',\\n    ')\n    }}\nFROM n8n_data.universal_datatable\nWHERE dataset_id = '{{ $('Insert Record Manager').first().json.dataset_id }}';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1304,208],"id":"create-dataset-view","name":"Create View","credentials":{"postgres":{"id":"5JhwTls4nSPISJqU","name":"Postgres account"}}}],"pinData":{},"connections":{"Webhook":{"main":[[{"node":"Parse CSV","type":"main","index":0}]]},"Parse CSV":{"main":[[{"node":"Mapping Logic","type":"main","index":0}]]},"Mapping Logic":{"main":[[{"node":"If Summary Empty","type":"main","index":0}]]},"If Summary Empty":{"main":[[{"node":"Sample Data","type":"main","index":0}],[{"node":"Set Without AI","type":"main","index":0}]]},"Sample Data":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"Clean Summary","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Clean Summary":{"main":[[{"node":"Set With AI Summary","type":"main","index":0}]]},"Set With AI Summary":{"main":[[{"node":"Insert Record Manager","type":"main","index":0}]]},"Set Without AI":{"main":[[{"node":"Insert Record Manager","type":"main","index":0}]]},"Merge":{"main":[[]]},"Insert Record Manager":{"main":[[{"node":"Data Transformer","type":"main","index":0}]]},"Data Transformer":{"main":[[{"node":"Insert Data","type":"main","index":0}]]},"Insert Data":{"main":[[{"node":"Create View","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":1}]]},"Create View":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"active":true,"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"versionId":"ecc70177-1b11-43c5-b8e9-decb9270c6dd","meta":{"templateCredsSetupCompleted":true,"instanceId":"558d88703fb65b2d0e44613bc35916258b0f0bf983c5d4730c00c424b77ca36a"},"id":"tkZS0zlAIT5YaR4l","tags":[]}